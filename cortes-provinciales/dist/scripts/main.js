"use strict";var SocialShare=SocialShare||{};$(document).ready(function(){!function(e){function t(e,t){if(!s[e])throw new Error("Share service not defined");var a=r(e,t);return n(a),this}function r(e,t){var r=s[e].shareurl,n=s[e].paramproto;t=t||{},"facebook"===e?t.u?t.u=i+t.u:t.u=i:"twitter"===e||(t.url?t.url=i+t.url:t.url=i),"linkedin"===e&&(t.mini&&"true"===t.mini||(t.mini="true"));var c=a(t,n),l=o(r,c);return l}function a(e,t){var r=[];e=e||{};for(var a in e)if(t.hasOwnProperty(a)){var o=t[a]+encodeURIComponent(e[a]);r.push(o)}return r}function o(e,t){t=t||[];var r=t.length?e+t.join("&"):e;return r}function n(e){var t=600,r=600,a=($(window).height()-r)/2,o=($(window).width()-t)/2,n="status=1,width="+t+",height="+r+",top="+a+",left="+o,i=e,s="_blank";return window.open(i,s,n),!1}var i=window.location.href,s={twitter:{shareurl:"http://twitter.com/intent/tweet?",paramproto:{text:"text=",url:"url=",hashtags:"hashtags=",via:"via=",related:"related="}},facebook:{shareurl:"http://www.facebook.com/sharer.php?",paramproto:{u:"u="}},linkedin:{shareurl:"http://www.linkedin.com/shareArticle?",paramproto:{url:"url=",mini:"mini=",title:"title=",summary:"summary=",source:"source="}},googleplus:{shareurl:"https://plus.google.com/share?",paramproto:{url:"url=",hl:"hl="}}};!function(){function e(e,t){return t=$.map(t,function(t,r){return e+"-"+t}),function(e){if(e){var r=$.map(t,function(e,t){return"."+e});return r.join(", ")}return t}}function r(e){function r(e){return $(this).hasClass(e)}var a=Array.prototype.slice.call($(this)[0].attributes),n={};$.each(a,function(e,t){var r=t.name,a=t.value;if(0===r.indexOf(o+"-")||0===r.indexOf("data-"+o+"-")){var i=r.split(o+"-")[1];n[i]=a}});var s=i.filter(r.bind(this));if(1===s.length){var c=s[0].split("-")[1];t(c,n)}}var a=Object.keys(s),o="share",n=e(o,a)(!0),i=e(o,a)(!1);$(n).on("click",r)}();var c={share:t};return e=$.extend(e,c)}(SocialShare)});var CHQ;d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},function(e,t,r,a){CHQ={},CHQ.pymChild=pym.Child({polling:500}),CHQ.$body=r("body"),CHQ.circles,CHQ.init=function(){var e=CHQ.$body.width();CHQ.$body.css("min-height",9*e/16),a.init({key:"1EqitwKNC18omv0NsAaFEmdU_hyYY_2LOLBkhWJ9NeSM",callback:CHQ.dataLoaded,simpleSheet:!1,parseNumbers:!0}),CHQ.inIframe()?r(".iframe-show").show():r(".no-iframe-show").show()},CHQ.postProcess=function(e,t){return e.id=t,e},CHQ.dataLoaded=function(e,t){CHQ.rawData=e["DATASET-VIZ"].elements.map(CHQ.postProcess),console.log(CHQ.rawData),CHQ.provinciasGroup=d3.nest().key(function(e){return e.provincia}).map(CHQ.rawData),CHQ.provincias=d3.keys(CHQ.provinciasGroup),console.log(CHQ.provincias),CHQ.$body.removeClass("loading"),CHQ.render(),setTimeout(CHQ.startEvents,2e3)},CHQ.startEvents=function(){r(window).resize(function(){clearTimeout(CHQ.timeoutId),CHQ.timeoutId=setTimeout(CHQ.render,500)}),r(".btn-year").on("click",function(){r(".btn-year").removeClass("btn-selected"),r(this).addClass("btn-selected"),CHQ.year=r(this).data("value"),CHQ.render()}),r(".btn-order").on("click",function(){r(".btn-order").removeClass("btn-selected"),r(this).addClass("btn-selected"),CHQ.group=r(this).data("value"),CHQ.render()}),r("#close-details").on("click",CHQ.closeDetails)},CHQ.render=function(){var e=r("#chart-container").width();CHQ.smallDevice=e<990;var t=100,a=e/3,o=(CHQ.provincias.length+1)*t,n=e,i=o;CHQ.chart||(CHQ.chart={},CHQ.chart.svg=d3.select("#chart-container").append("svg").attr("id","main-chart-svg"),CHQ.chart.circlesGroup=CHQ.chart.svg.append("g").attr("id","circles-chart-group"),CHQ.chart.provinciasGroup=CHQ.chart.svg.append("g").attr("id","provincias-chart-group"),CHQ.tooltip=d3.select("body").append("div").attr("id","circle-tooltip"),CHQ.selector=CHQ.chart.svg.append("circle").attr("id","selector").style("stroke-width",3).style("opacity",0).attr("fill","none")),CHQ.chart.svg.attr("width",n).attr("height",i),CHQ.chart.provincias=CHQ.chart.provinciasGroup.selectAll("g.provincia-group").data(CHQ.provincias),CHQ.chart.provincias.enter().append("g").classed("provincia-group",!0).each(function(e){var r=d3.select(this);r.append("text").datum(e).attr("y",t/2-5).classed("text-provincia",!0).attr("text-anchor","end").text(function(e){return e}),r.append("rect").datum(e).classed("aliado-col",!0).attr("fill","orange"),r.append("rect").datum(e).classed("opositor-col",!0).attr("fill","steelblue")}),CHQ.chart.provincias.selectAll("rect.aliado-col").attr("x",a).attr("width",a).attr("height",t),CHQ.chart.provincias.selectAll("rect.opositor-col").attr("x",2*a).attr("width",a).attr("height",t),CHQ.chart.provincias.selectAll("text.text-provincia").attr("x",a),CHQ.chart.provincias.transition().attr("transform",function(e,r){return"translate(0,"+(r+1)*t+")"})},CHQ.renderSelect=function(e){if(CHQ.selectedId){var t=CHQ.dataById[CHQ.selectedId];e=e?e:t.sector}var a=r("#tpl-select-industry").html();Mustache.parse(a);var o={categories:CHQ.categories.map(function(t){var r=!!e&&t==e;return{val:t,txt:t,sel:r}}),empresasOption:!!e,empresas:!!e&&CHQ.groups[e].map(function(e){var t=e.id==CHQ.selectedId;return{val:e.id,txt:e.empresa,sel:t}})};o.categories.unshift({val:"",txt:"< sector >",sel:!e});var n=Mustache.render(a,o);r("#select-block").html(n),r("#category").on("change",function(){var e=r(this).val();""!=e&&(CHQ.renderSelect(e),r("#empresa").change())}),r("#empresa").on("change",function(){var e=r(this).val();CHQ.openDetails(CHQ.dataById[e]),d3.selectAll("circle").classed("selected",!1),d3.select("circle#e"+e).classed("selected",!0).style("stroke",function(e){return d3.rgb(CHQ.color(e.data.sector)).darker().toString()})})},CHQ.openDetails=function(e){r("body").addClass("detailsOpened"),CHQ.selectedId=e.id,CHQ.$colChart.hasClass("col-md-12")&&(CHQ.$colChart.removeClass("col-md-12").addClass("col-md-7"),CHQ.render(),CHQ.$details.fadeIn(),CHQ.$tips.hide(),CHQ.$colOptions.removeClass("col-sm-7").addClass("col-sm-12"));var t=r("#tpl-details").html();Mustache.parse(t),e.color=CHQ.color(e.sector),e.selectedYear=CHQ.year,e.isPromedio="promedio"==CHQ.year,e.selectedValue=(e["porcentaje_"+CHQ.year]+"").replace(".",","),e.noPresentaron=!!isNaN(e["porcentaje_"+CHQ.year]),console.log(e);var a=Mustache.render(t,e);r("#details-block").html(a);var o={};r.each(e,function(e,t){e.indexOf("_")!==-1&&(e=e.split("_"),o[e[1]]=!0)}),o=d3.keys(o).sort();var n=[];r.each(o,function(t,a){var o={anio:a};r.each(e,function(e,t){e.indexOf("_")!==-1&&(e=e.split("_"),e[1]==a&&(o[e[0]]=t))}),n.push(o)});var i=n.filter(function(e){return"promedio"==e.anio})[0],s=[{value:i.porcentaje,text:i.porcentaje+"% promedio"}];n=n.filter(function(e){return"promedio"!=e.anio});var c={json:n,keys:{x:"anio",value:["porcentaje"]},type:"bar",colors:{porcentaje:e.color}};CHQ.pchart=c3.generate({bindto:"#per-chart",data:c,bar:{width:{ratio:.5}},size:{height:100},axis:{y:{label:"Porcentaje",min:0,show:!1,padding:{bottom:0,top:10}},x:{type:"category"}},grid:{y:{lines:s}},legend:{show:!1},tooltip:{format:{value:function(e,t,r,a){return(e+"%").replace(".",",")}}}});var l={json:n,keys:{x:"anio",value:["ganancias","ventas"]},type:"line",names:{ventas:"Ventas",ganancias:"Pago de ganancias"},colors:{ganancias:e.color,ventas:d3.rgb(e.color).darker()}};CHQ.chart?CHQ.chart.load(l):CHQ.chart=c3.generate({bindto:"#line-chart",data:l,axis:{y:{min:0,tick:{format:function(e){return d3.format("$,")(e).replace(/,/g,".")}},padding:{bottom:0}},x:{type:"category",tick:{outer:!1}}}}),CHQ.renderSelect()},CHQ.closeDetails=function(){r("body").removeClass("detailsOpened"),CHQ.selectedId=!1,CHQ.$colChart.removeClass("col-md-7").addClass("col-md-12"),CHQ.$colOptions.removeClass("col-sm-12").addClass("col-sm-7"),CHQ.render(),CHQ.$details.hide(),CHQ.$tips.show(),d3.selectAll("circle").classed("selected",!1)},CHQ.inIframe=function(){try{return window.self!==window.top}catch(e){return!0}}}(window,document,jQuery,Tabletop);