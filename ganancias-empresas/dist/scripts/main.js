"use strict";var CHQ;!function(e,t,a,r,n){CHQ={},CHQ.pymChild=pym.Child({polling:500}),CHQ.$details=a("#details"),CHQ.$body=a("body"),CHQ.$colChart=a("#col-chart-container"),CHQ.circles,CHQ.year="2015",CHQ.group="center",CHQ.init=function(){var e=CHQ.$body.width();CHQ.$body.css("min-height",9*e/16),r.init({key:"1lZH4R70Ln3vqZFnDvySuA681kKJJWc49GEoFJwpKLDc",callback:CHQ.dataLoaded,simpleSheet:!1,parseNumbers:!0})},CHQ.postProcess=function(e,t){return e.max=0,e.id=t,a.each(e,function(t,a){0==t.indexOf("porcentaje_")&&(e[t]=parseFloat(e[t].replace(",",".")),e[t]>e.max&&(e.max=e[t]))}),e},CHQ.dataLoaded=function(e,t){CHQ.rawData=e.detalle.elements.map(CHQ.postProcess),CHQ.groups=d3.nest().key(function(e){return e.sector.trim()}).map(CHQ.rawData),CHQ.categories=d3.keys(CHQ.groups),CHQ.dataById=d3.nest().key(function(e){return e.id}).rollup(function(e){return e[0]}).map(CHQ.rawData),CHQ.maxValue=d3.max(CHQ.rawData,function(e){return e.max}),CHQ.$body.removeClass("loading"),CHQ.render(),setTimeout(CHQ.startEvents,2e3)},CHQ.filterData=function(){var e=CHQ.rawData.filter(function(e){return!isNaN(e["porcentaje_"+CHQ.year])});CHQ.data=e.map(function(e){return{id:e.id,empresa:e.empresa,sector:e.sector,anio:CHQ.year,porcentaje:e["porcentaje_"+CHQ.year]}})},CHQ.startEvents=function(){CHQ.circles.on("click",function(e){CHQ.openDetails(CHQ.dataById[e.data.id]),d3.selectAll("circle").classed("selected",!1),d3.select(this).classed("selected",!0)}).on("mouseenter",function(e){CHQ.tooltip.html("<strong>"+e.data.empresa+"</strong> pagó el <strong>"+e.data.porcentaje+"%</strong> en el año <strong>"+e.data.anio+"</strong>").style("opacity",1),d3.select(this).attr("stroke",d3.rgb(CHQ.color(e.data.sector)).darker().toString())}).on("mousemove",function(){CHQ.tooltip.style("top",d3.event.pageY-20+"px").style("left",d3.event.pageX+20+"px")}).on("mouseout",function(e){CHQ.tooltip.style("opacity",0),d3.select(this).attr("fill",function(){})}),a(window).resize(function(){clearTimeout(CHQ.timeoutId),CHQ.timeoutId=setTimeout(CHQ.render,500)}),a(".btn-year").on("click",function(){a(".btn-year").removeClass("btn-primary"),a(this).addClass("btn-primary"),CHQ.year=a(this).data("value"),CHQ.render()}),a(".btn-order").on("click",function(){a(".btn-order").removeClass("btn-primary"),a(this).addClass("btn-primary"),CHQ.group=a(this).data("value"),CHQ.render()}),a("#close-details").on("click",CHQ.closeDetails)},CHQ.render=function(){function e(e){CHQ.circles.each(t(10*e.alpha*e.alpha)).each(r(.5)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}function t(e){return function(t){var a=Q[t.cluster],r=1;if(a){a===t&&(m?(a=m[t.cluster],a={x:a.x,y:a.y,radius:-a.radius},r=.5*Math.sqrt(t.radius)):(a={x:s/2,y:i/2,radius:-t.radius},r=.1*Math.sqrt(t.radius)));var n=t.x-a.x,o=t.y-a.y,c=Math.sqrt(n*n+o*o),l=t.radius+a.radius;c!=l&&(c=(c-l)/c*e*r,t.x-=n*=c,t.y-=o*=c,a.x+=n,a.y+=o)}}}function r(e){var t=d3.geom.quadtree(p);return function(a){var r=a.radius+d+Math.max(c,l),n=a.x-r,o=a.x+r,s=a.y-r,i=a.y+r;t.visit(function(t,r,d,u,C){if(t.point&&t.point!==a){var H=a.x-t.point.x,Q=a.y-t.point.y,p=Math.sqrt(H*H+Q*Q),y=a.radius+t.point.radius+(a.cluster===t.point.cluster?c:l);p<y&&(p=(p-y)/p*e,a.x-=H*=p,a.y-=Q*=p,t.point.x+=H,t.point.y+=Q)}return r>o||u<n||d>i||C<s})}}CHQ.filterData();var n=a("#chart-container").width(),o=CHQ.$colChart.hasClass("col-md-12")?9*n/16:n,s=n,i=o,c=2,l=2,d=n/25,u=n/100,C=n/75,H=n/150;CHQ.color=d3.scale.category20().domain(CHQ.categories);var Q,p,y;switch(CHQ.group){case"center":y=d3.scale.linear().domain([0,CHQ.maxValue]).range([u,d]),Q=new Array(CHQ.categories.length),p=CHQ.data.map(function(e){var t=e.sector,a=y(e.porcentaje),e={cluster:t,radius:a,data:e};return(!Q[t]||a>Q[t].radius)&&(Q[t]=e),e});break;case"sector":y=d3.scale.linear().domain([0,CHQ.maxValue]).range([H,C]),Q=new Array(CHQ.categories.length);var m=new Array(CHQ.categories.length),h=[],f=Math.floor(s/11),g=Math.floor(i/4),v=d3.range(0,s,f),x=d3.range(0,i,g),b=0,w=1;p=CHQ.data.map(function(e){var t=e.sector,a=y(e.porcentaje),e={cluster:t,radius:a,data:e};return m[t]||(v[b+2]?b+=1:(b=1,w+=1),m[t]={x:v[b],y:x[w],radius:3},h.push(m[t])),(!Q[t]||a>Q[t].radius)&&(Q[t]=e),e})}var k=d3.layout.force().nodes(p).size([s,i]).gravity(0).charge(0).on("tick",e).start();CHQ.svg||(CHQ.svg=d3.select("#chart-container").append("svg"),CHQ.tooltip=d3.select("body").append("div").attr("id","circle-tooltip")),CHQ.svg.attr("width",s).attr("height",i),CHQ.circles=CHQ.svg.selectAll("circle.company").data(p),CHQ.circles.enter().append("circle").classed("company",!0),CHQ.circles.attr("r",function(e){return e.radius}).style("fill",function(e){return CHQ.color(e.cluster)}).call(k.drag),CHQ.circles.exit().remove()},CHQ.openDetails=function(e){CHQ.$colChart.hasClass("col-md-12")&&(CHQ.$colChart.removeClass("col-md-12").addClass("col-md-6"),CHQ.render(),CHQ.$details.fadeIn());var t=a("#tpl-details").html();n.parse(t),e.color=CHQ.color(e.sector);var r=n.render(t,e);a("#details-block").html(r);var o={};a.each(e,function(e,t){e.indexOf("_")!==-1&&(e=e.split("_"),o[e[1]]=!0)}),o=d3.keys(o).sort();var s=[];a.each(o,function(t,r){var n={anio:r};a.each(e,function(e,t){e.indexOf("_")!==-1&&(e=e.split("_"),e[1]==r&&(n[e[0]]=t))}),s.push(n)});var i={json:s,keys:{x:"anio",value:["ganancias","ventas","porcentaje"]},axes:{porcentaje:"y2"},type:"line",types:{porcentaje:"bar"}};CHQ.chart?CHQ.chart.load(i):CHQ.chart=c3.generate({bindto:"#line-chart",data:i,bar:{width:{ratio:.2}},axis:{y2:{show:!0,min:0,label:"Porcentaje"},y:{min:0,label:"Ganancias / Ventas"},x:{type:"category"}}})},CHQ.closeDetails=function(){CHQ.$colChart.removeClass("col-md-6").addClass("col-md-12"),CHQ.render(),CHQ.$details.hide(),d3.selectAll("circle").classed("selected",!1)}}(window,document,jQuery,Tabletop,Mustache);