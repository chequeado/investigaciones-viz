"use strict";var CHQ;d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},function(e,t,a,r,o){CHQ={},CHQ.pymChild=pym.Child({polling:500}),CHQ.$details=a("#details"),CHQ.$body=a("body"),CHQ.$colChart=a("#col-chart-container"),CHQ.circles,CHQ.year="2015",CHQ.group="center",CHQ.init=function(){var e=CHQ.$body.width();CHQ.$body.css("min-height",9*e/16),r.init({key:"1lZH4R70Ln3vqZFnDvySuA681kKJJWc49GEoFJwpKLDc",callback:CHQ.dataLoaded,simpleSheet:!1,parseNumbers:!0})},CHQ.postProcess=function(e,t){return e.max=0,e.id=t,a.each(e,function(t,a){0==t.indexOf("porcentaje_")&&(e[t]=parseFloat(e[t].replace(",",".")),e[t]>e.max&&(e.max=e[t]))}),e},CHQ.dataLoaded=function(e,t){CHQ.rawData=e.detalle.elements.map(CHQ.postProcess),CHQ.groups=d3.nest().key(function(e){return e.sector.trim()}).map(CHQ.rawData),CHQ.categories=d3.keys(CHQ.groups),CHQ.dataById=d3.nest().key(function(e){return e.id}).rollup(function(e){return e[0]}).map(CHQ.rawData),CHQ.maxValue=d3.max(CHQ.rawData,function(e){return e.max}),CHQ.$body.removeClass("loading"),CHQ.render(),setTimeout(CHQ.startEvents,2e3)},CHQ.filterData=function(){var e=CHQ.rawData.filter(function(e){return!isNaN(e["porcentaje_"+CHQ.year])});CHQ.data=e.map(function(e){return{id:e.id,empresa:e.empresa,sector:e.sector,anio:CHQ.year,porcentaje:e["porcentaje_"+CHQ.year]}})},CHQ.startEvents=function(){CHQ.circles.on("click",function(e){CHQ.openDetails(CHQ.dataById[e.data.id]),d3.selectAll("circle").classed("selected",!1),d3.select(this).classed("selected",!0)}).on("mouseenter",function(e){var t=d3.select(this);CHQ.selector.attr("stroke",d3.rgb(CHQ.color(e.data.sector)).darker().toString()).attr("r",Math.round(t.attr("r"))).attr("cx",t.attr("cx")).attr("cy",t.attr("cy")).style("opacity",1).transition().delay(200).style("opacity",0).attr("r",Math.round(t.attr("r"))+30),CHQ.tooltip.html("<strong>"+e.data.empresa+"</strong> pagó el <strong>"+(e.data.porcentaje+"").replace(".",",")+"%</strong> en el año <strong>"+e.data.anio+"</strong>").style("opacity",1),t.attr("stroke",d3.rgb(CHQ.color(e.data.sector)).darker().toString())}).on("mousemove",function(){CHQ.tooltip.style("top",d3.event.pageY-20+"px").style("left",d3.event.pageX+20+"px")}).on("mouseout",function(e){CHQ.tooltip.style("opacity",0),d3.select(this).attr("fill",function(){})}),a(window).resize(function(){clearTimeout(CHQ.timeoutId),CHQ.timeoutId=setTimeout(CHQ.render,500)}),a(".btn-year").on("click",function(){a(".btn-year").removeClass("btn-selected"),a(this).addClass("btn-selected"),CHQ.year=a(this).data("value"),CHQ.render()}),a(".btn-order").on("click",function(){a(".btn-order").removeClass("btn-selected"),a(this).addClass("btn-selected"),CHQ.group=a(this).data("value"),CHQ.render()}),a("#close-details").on("click",CHQ.closeDetails)},CHQ.render=function(){function e(e){CHQ.circles.each(t(10*e.alpha*e.alpha)).each(r(.5)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}function t(e){return function(t){var a=Q[t.cluster],r=1;if(a){a===t&&(h?(a=h[t.cluster],a={x:a.x,y:a.y,radius:-a.radius},r=.5*Math.sqrt(t.radius)):(a={x:c/2,y:s/2,radius:-t.radius},r=.1*Math.sqrt(t.radius)));var o=t.x-a.x,n=t.y-a.y,i=Math.sqrt(o*o+n*n),l=t.radius+a.radius;i!=l&&(i=(i-l)/i*e*r,t.x-=o*=i,t.y-=n*=i,a.x+=o,a.y+=n)}}}function r(e){var t=d3.geom.quadtree(p);return function(a){var r=a.radius+d+Math.max(i,l),o=a.x-r,n=a.x+r,c=a.y-r,s=a.y+r;t.visit(function(t,r,d,u,C){if(t.point&&t.point!==a){var H=a.x-t.point.x,Q=a.y-t.point.y,p=Math.sqrt(H*H+Q*Q),y=a.radius+t.point.radius+(a.cluster===t.point.cluster?i:l);p<y&&(p=(p-y)/p*e,a.x-=H*=p,a.y-=Q*=p,t.point.x+=H,t.point.y+=Q)}return r>n||u<o||d>s||C<c})}}CHQ.filterData();var o=a("#chart-container").width(),n=CHQ.$colChart.hasClass("col-md-12")?9*o/16:o,c=o,s=n,i=2,l=2,d=o/25,u=o/100,C=o/75,H=o/150;CHQ.color=d3.scale.category20().domain(CHQ.categories);var Q,p,y;switch(CHQ.group){case"center":y=d3.scale.linear().domain([0,CHQ.maxValue]).range([u,d]),Q=new Array(CHQ.categories.length),p=CHQ.data.map(function(e){var t=e.sector,a=y(e.porcentaje),e={cluster:t,radius:a,data:e};return(!Q[t]||a>Q[t].radius)&&(Q[t]=e),e});break;case"sector":y=d3.scale.linear().domain([0,CHQ.maxValue]).range([H,C]),Q=new Array(CHQ.categories.length);var h=new Array(CHQ.categories.length),f=[],m=Math.floor(c/11),g=Math.floor(s/4),v=d3.range(0,c,m),x=d3.range(0,s,g),b=0,k=1;p=CHQ.data.map(function(e){var t=e.sector,a=y(e.porcentaje),e={cluster:t,radius:a,data:e};return h[t]||(v[b+2]?b+=1:(b=1,k+=1),h[t]={x:v[b],y:x[k],radius:3},f.push(h[t])),(!Q[t]||a>Q[t].radius)&&(Q[t]=e),e})}var w=d3.layout.force().nodes(p).size([c,s]).gravity(0).charge(0).on("tick",e).start();CHQ.svg||(CHQ.svg=d3.select("#chart-container").append("svg"),CHQ.tooltip=d3.select("body").append("div").attr("id","circle-tooltip"),CHQ.selector=CHQ.svg.append("circle").attr("id","selector").style("stroke-width",3).style("opacity",0).attr("fill","none")),CHQ.svg.attr("width",c).attr("height",s),CHQ.circles=CHQ.svg.selectAll("circle.company").data(p),CHQ.circles.enter().append("circle").classed("company",!0),CHQ.circles.attr("id",function(e){return"e"+e.data.id}).attr("r",function(e){return e.radius}).style("fill",function(e){return CHQ.color(e.cluster)}).call(w.drag),CHQ.circles.exit().remove(),CHQ.selector.moveToFront(),CHQ.selectedId&&(CHQ.openDetails(CHQ.dataById[CHQ.selectedId]),d3.selectAll("circle").classed("selected",!1),d3.select("#e"+CHQ.selectedId).classed("selected",!0))},CHQ.openDetails=function(e){CHQ.selectedId=e.id,CHQ.$colChart.hasClass("col-md-12")&&(CHQ.$colChart.removeClass("col-md-12").addClass("col-md-6"),CHQ.render(),CHQ.$details.fadeIn());var t=a("#tpl-details").html();o.parse(t),e.color=CHQ.color(e.sector),e.selectedYear=CHQ.year,e.selectedValue=(e["porcentaje_"+CHQ.year]+"").replace(".",",");var r=o.render(t,e);a("#details-block").html(r);var n={};a.each(e,function(e,t){e.indexOf("_")!==-1&&(e=e.split("_"),n[e[1]]=!0)}),n=d3.keys(n).sort();var c=[];a.each(n,function(t,r){var o={anio:r};a.each(e,function(e,t){e.indexOf("_")!==-1&&(e=e.split("_"),e[1]==r&&(o[e[0]]=t))}),c.push(o)});var s={json:c,keys:{x:"anio",value:["porcentaje"]},type:"bar",colors:{porcentaje:e.color}};CHQ.pchart=c3.generate({bindto:"#per-chart",data:s,bar:{width:{ratio:.5}},size:{height:100},axis:{y:{label:"Porcentaje",min:0,show:!1},x:{type:"category"}},grid:{y:{lines:[{value:0,text:" "}]}},legend:{show:!1},tooltip:{format:{value:function(e,t,a,r){return(e+"%").replace(".",",")}}}});var i={json:c,keys:{x:"anio",value:["ganancias","ventas"]},type:"line",colors:{ganancias:e.color,ventas:d3.rgb(e.color).darker()}};CHQ.chart?CHQ.chart.load(i):CHQ.chart=c3.generate({bindto:"#line-chart",data:i,axis:{y:{min:0,tick:{format:function(e){return d3.format("$,")(e).replace(/,/g,".")}}},x:{type:"category",tick:{outer:!1}}},grid:{y:{lines:[{value:0,text:" "}]}}})},CHQ.closeDetails=function(){CHQ.selectedId=!1,CHQ.$colChart.removeClass("col-md-6").addClass("col-md-12"),CHQ.render(),CHQ.$details.hide(),d3.selectAll("circle").classed("selected",!1)}}(window,document,jQuery,Tabletop,Mustache);