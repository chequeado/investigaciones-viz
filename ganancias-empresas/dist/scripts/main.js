"use strict";var CHQ;!function(t,a,e,r){CHQ={},CHQ.pymChild=pym.Child({polling:500}),CHQ.init=function(){console.log("init"),r.init({key:"1lZH4R70Ln3vqZFnDvySuA681kKJJWc49GEoFJwpKLDc",callback:CHQ.dataLoaded,simpleSheet:!1,parseNumbers:!0})},CHQ.postProcess=function(t,a){return t.max=0,t.id=a,e.each(t,function(a,e){0==a.indexOf("porcentaje_")&&(t[a]=parseFloat(t[a].replace(",",".")),t[a]>t.max&&(t.max=t[a]))}),t},CHQ.dataLoaded=function(t,a){CHQ.rawData=t.detalle.elements.map(CHQ.postProcess),CHQ.groups=d3.nest().key(function(t){return t.sector}).map(CHQ.rawData),CHQ.categories=d3.keys(CHQ.groups),CHQ.dataById=d3.nest().key(function(t){return t.id}).rollup(function(t){return t[0]}).map(CHQ.rawData),CHQ.maxValue=d3.max(CHQ.rawData,function(t){return t.max}),CHQ.filterData("2015"),CHQ.render(),CHQ.startEvents()},CHQ.filterData=function(t){var a=CHQ.rawData.filter(function(a){return!isNaN(a["porcentaje_"+t])});CHQ.data=a.map(function(a){return{id:a.id,empresa:a.empresa,sector:a.sector,anio:t,porcentaje:a["porcentaje_"+t]}})},CHQ.startEvents=function(){e(window).resize(function(){clearTimeout(CHQ.timeoutId),CHQ.timeoutId=setTimeout(CHQ.render,500)}),e("#year").change(function(){e("#detalle").html(""),CHQ.filterData(e(this).val()),CHQ.render()})},CHQ.render=function(){function t(t){p.each(a(10*t.alpha*t.alpha)).each(r(.5)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}function a(t){return function(a){var e=C[a.cluster],r=1;if(e){e===a&&(e={x:i/2,y:o/2,radius:-a.radius},r=.1*Math.sqrt(a.radius));var n=a.x-e.x,c=a.y-e.y,s=Math.sqrt(n*n+c*c),u=a.radius+e.radius;s!=u&&(s=(s-u)/s*t*r,a.x-=n*=s,a.y-=c*=s,e.x+=n,e.y+=c)}}}function r(t){var a=d3.geom.quadtree(H);return function(e){var r=e.radius+u+Math.max(c,s),n=e.x-r,i=e.x+r,o=e.y-r,d=e.y+r;a.visit(function(a,r,u,l,C){if(a.point&&a.point!==e){var H=e.x-a.point.x,Q=e.y-a.point.y,p=Math.sqrt(H*H+Q*Q),f=e.radius+a.point.radius+(e.cluster===a.point.cluster?c:s);p<f&&(p=(p-f)/p*t,e.x-=H*=p,e.y-=Q*=p,a.point.x+=H,a.point.y+=Q)}return r>i||l<n||u>d||C<o})}}console.log(CHQ.groups),console.log(CHQ.categories);var n=e("#chart-container").width(),i=n,o=9*n/16,c=1.5,s=10,u=n/20,d=d3.scale.category10().domain(CHQ.categories);console.log("color",d.domain());var l=d3.scale.linear().domain([0,CHQ.maxValue]).range([0,u]),C=new Array(CHQ.categories.length),H=CHQ.data.map(function(t){var a=t.sector,e=l(t.porcentaje),t={cluster:a,radius:e,data:t};return(!C[a]||e>C[a].radius)&&(C[a]=t),t}),Q=d3.layout.force().nodes(H).size([i,o]).gravity(0).charge(0).on("tick",t).start();CHQ.svg||(CHQ.svg=d3.select("#chart-container").append("svg")),CHQ.svg.attr("width",i).attr("height",o);var p=CHQ.svg.selectAll("circle").data(H);p.enter().append("circle").on("click",function(t){e("#detalle").html("BASE: "+JSON.stringify(t.data)+" HISTORICO: "+JSON.stringify(CHQ.dataById[t.data.id]))}),p.attr("r",function(t){return t.radius}).style("fill",function(t){return d(t.cluster)}).call(Q.drag),p.exit().remove()}}(window,document,jQuery,Tabletop);