"use strict";var CHQ;!function(t,e,a,r,n){CHQ={},CHQ.pymChild=pym.Child({polling:500}),CHQ.$details=a("#details"),CHQ.$body=a("body"),CHQ.$colChart=a("#col-chart-container"),CHQ.circles,CHQ.init=function(){var t=CHQ.$body.width();CHQ.$body.css("min-height",9*t/16),r.init({key:"1lZH4R70Ln3vqZFnDvySuA681kKJJWc49GEoFJwpKLDc",callback:CHQ.dataLoaded,simpleSheet:!1,parseNumbers:!0})},CHQ.postProcess=function(t,e){return t.max=0,t.id=e,a.each(t,function(e,a){0==e.indexOf("porcentaje_")&&(t[e]=parseFloat(t[e].replace(",",".")),t[e]>t.max&&(t.max=t[e]))}),t},CHQ.dataLoaded=function(t,e){CHQ.rawData=t.detalle.elements.map(CHQ.postProcess),CHQ.groups=d3.nest().key(function(t){return t.sector}).map(CHQ.rawData),CHQ.categories=d3.keys(CHQ.groups),CHQ.dataById=d3.nest().key(function(t){return t.id}).rollup(function(t){return t[0]}).map(CHQ.rawData),CHQ.maxValue=d3.max(CHQ.rawData,function(t){return t.max}),CHQ.$body.removeClass("loading"),CHQ.filterData("2015"),CHQ.render(),setTimeout(CHQ.startEvents,1e3)},CHQ.filterData=function(t){var e=CHQ.rawData.filter(function(e){return!isNaN(e["porcentaje_"+t])});CHQ.data=e.map(function(e){return{id:e.id,empresa:e.empresa,sector:e.sector,anio:t,porcentaje:e["porcentaje_"+t]}})},CHQ.startEvents=function(){CHQ.circles.on("click",function(t){CHQ.openDetails(CHQ.dataById[t.data.id]),d3.selectAll("circle").classed("selected",!1),d3.select(this).classed("selected",!0)}).on("mouseenter",function(t){CHQ.tooltip.html("<strong>"+t.data.empresa+"</strong> pagó el <strong>"+t.data.porcentaje+"%</strong> en el año <strong>"+t.data.anio+"</strong>").style("opacity",1),d3.select(this).attr("stroke",d3.rgb(CHQ.color(t.data.sector)).darker().toString())}).on("mousemove",function(){CHQ.tooltip.style("top",d3.event.pageY-20+"px").style("left",d3.event.pageX+20+"px")}).on("mouseout",function(t){CHQ.tooltip.style("opacity",0),d3.select(this).attr("fill",function(){})}),a(window).resize(function(){clearTimeout(CHQ.timeoutId),CHQ.timeoutId=setTimeout(CHQ.render,500)}),a("#year").change(function(){CHQ.filterData(a(this).val()),CHQ.render()}),a("#close-details").on("click",CHQ.closeDetails)},CHQ.render=function(){function t(t){CHQ.circles.each(e(10*t.alpha*t.alpha)).each(r(.5)).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y})}function e(t){return function(e){var a=H[e.cluster],r=1;if(a){a===e&&(a={x:i/2,y:c/2,radius:-e.radius},r=.1*Math.sqrt(e.radius));var n=e.x-a.x,o=e.y-a.y,s=Math.sqrt(n*n+o*o),l=e.radius+a.radius;s!=l&&(s=(s-l)/s*t*r,e.x-=n*=s,e.y-=o*=s,a.x+=n,a.y+=o)}}}function r(t){var e=d3.geom.quadtree(Q);return function(a){var r=a.radius+d+Math.max(s,l),n=a.x-r,o=a.x+r,i=a.y-r,c=a.y+r;e.visit(function(e,r,d,u,C){if(e.point&&e.point!==a){var H=a.x-e.point.x,Q=a.y-e.point.y,p=Math.sqrt(H*H+Q*Q),m=a.radius+e.point.radius+(a.cluster===e.point.cluster?s:l);p<m&&(p=(p-m)/p*t,a.x-=H*=p,a.y-=Q*=p,e.point.x+=H,e.point.y+=Q)}return r>o||u<n||d>c||C<i})}}var n=a("#chart-container").width(),o=CHQ.$colChart.hasClass("col-md-12")?9*n/16:n,i=n,c=o,s=1.5,l=10,d=n/25,u=n/100;CHQ.color=d3.scale.category20().domain(CHQ.categories);var C=d3.scale.linear().domain([0,CHQ.maxValue]).range([u,d]),H=new Array(CHQ.categories.length),Q=CHQ.data.map(function(t){var e=t.sector,a=C(t.porcentaje),t={cluster:e,radius:a,data:t};return(!H[e]||a>H[e].radius)&&(H[e]=t),t}),p=d3.layout.force().nodes(Q).size([i,c]).gravity(0).charge(0).on("tick",t).start();CHQ.svg||(CHQ.svg=d3.select("#chart-container").append("svg"),CHQ.tooltip=d3.select("body").append("div").attr("id","circle-tooltip")),CHQ.svg.attr("width",i).attr("height",c),CHQ.circles=CHQ.svg.selectAll("circle").data(Q),CHQ.circles.enter().append("circle"),CHQ.circles.attr("r",function(t){return t.radius}).style("fill",function(t){return CHQ.color(t.cluster)}).call(p.drag),CHQ.circles.exit().remove()},CHQ.openDetails=function(t){CHQ.$colChart.hasClass("col-md-12")&&(CHQ.$colChart.removeClass("col-md-12").addClass("col-md-6"),CHQ.render(),CHQ.$details.fadeIn());var e=a("#template").html();n.parse(e),t.color=CHQ.color(t.sector);var r=n.render(e,t);a("#details-block").html(r);var o={};a.each(t,function(t,e){t.indexOf("_")!==-1&&(t=t.split("_"),o[t[1]]=!0)}),o=d3.keys(o).sort();var i=[];a.each(o,function(e,r){var n={anio:r};a.each(t,function(t,e){t.indexOf("_")!==-1&&(t=t.split("_"),t[1]==r&&(n[t[0]]=e))}),i.push(n)});var c={json:i,keys:{x:"anio",value:["ganancias","ventas","porcentaje"]},axes:{porcentaje:"y2"},type:"line",types:{porcentaje:"bar"}};CHQ.chart?CHQ.chart.load(c):CHQ.chart=c3.generate({bindto:"#line-chart",data:c,bar:{width:{ratio:.2}},axis:{y2:{show:!0,min:0,label:"Porcentaje"},y:{min:0,label:"Ganancias / Ventas"},x:{min:0,type:"category"}}})},CHQ.closeDetails=function(){CHQ.$colChart.removeClass("col-md-6").addClass("col-md-12"),CHQ.render(),CHQ.$details.hide()}}(window,document,jQuery,Tabletop,Mustache);